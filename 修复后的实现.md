# 🎯 GLM 去水印和比例控制 - 修复后的正确实现

## 🔍 关键发现

用户提供了GLM API的实际参数格式，揭示了我们之前实现的问题：

### ❌ 之前的错误实现
```typescript
const requestBody = {
  label_watermark: 0,  // 错误：参数位置不对
  ratioWidth: 608,     // 错误：参数名称不对
  ratioHeight: 1080,   // 错误：参数名称不对
};
```

### ✅ 正确的参数格式
```json
{
  "prompt": "做的视频",
  "conversation_id": "",
  "source_list": ["68b4fe2da70dd0476f9c18e6"],
  "base_parameter_extra": {
    "generation_pattern": 1,
    "resolution": 1,
    "fps": 1,
    "duration": 1,
    "generation_ai_audio": 0,
    "generation_ratio_width": 326,    // 正确：比例宽度参数
    "generation_ratio_height": 580,   // 正确：比例高度参数
    "activity_type": 0,
    "label_watermark": 1,             // 正确：去水印参数位置
    "prompt": "做的视频"
  }
}
```

## 🔧 修复实现

### 新的请求体结构
```typescript
const requestBody = {
  conversation_id: refConvId,
  prompt,
  source_list: sourceList.length > 0 ? sourceList : undefined,
  base_parameter_extra: {
    generation_pattern: options.options?.generationPattern ?? 1,
    resolution: options.options?.resolution ?? 2,
    fps: options.options?.fps ?? 60,
    duration: options.options?.duration ?? 1,
    generation_ai_audio: 0,
    generation_ratio_width: options.options?.ratioWidth ?? 608,   // 正确的比例参数
    generation_ratio_height: options.options?.ratioHeight ?? 1080, // 正确的比例参数
    activity_type: 0,
    label_watermark: options.labelWatermark ?? 0,  // 正确位置的去水印参数
    prompt: prompt
  },
  advanced_parameter_extra: {
    emotional_atmosphere: options.emotionalAtmosphere,
    mirror_mode: options.mirrorMode,
    video_style: options.videoStyle,
  },
};
```

## 📊 参数对照表

| 功能 | 错误参数名 | 正确参数名 | 位置 |
|------|------------|------------|------|
| 去水印 | `label_watermark` (根级别) | `label_watermark` | `base_parameter_extra` |
| 比例宽度 | `ratioWidth` | `generation_ratio_width` | `base_parameter_extra` |
| 比例高度 | `ratioHeight` | `generation_ratio_height` | `base_parameter_extra` |
| 生成模式 | `generationPattern` | `generation_pattern` | `base_parameter_extra` |

## 🎯 9:16 比例设置

### 完美9:16比例
```json
{
  "options": {
    "ratioWidth": 540,   // 对应 generation_ratio_width
    "ratioHeight": 960   // 对应 generation_ratio_height
  }
}
```

### 其他常用比例
- **16:9 横向**: `ratioWidth: 960, ratioHeight: 540`
- **1:1 正方形**: `ratioWidth: 720, ratioHeight: 720`
- **4:3 传统**: `ratioWidth: 720, ratioHeight: 960`

## 🧪 测试验证

### 测试请求
```json
{
  "model": "cogvideox",
  "prompt": "测试正确的去水印格式",
  "label_watermark": 0,
  "image_url": "https://...",
  "options": {
    "generationPattern": 1,
    "resolution": 2,
    "fps": 60,
    "duration": 1,
    "ratioWidth": 540,
    "ratioHeight": 960
  }
}
```

### 预期GLM API接收到的格式
```json
{
  "conversation_id": "...",
  "prompt": "测试正确的去水印格式",
  "source_list": [...],
  "base_parameter_extra": {
    "generation_pattern": 1,
    "resolution": 2,
    "fps": 60,
    "duration": 1,
    "generation_ai_audio": 0,
    "generation_ratio_width": 540,
    "generation_ratio_height": 960,
    "activity_type": 0,
    "label_watermark": 0,  // 0 = 无水印
    "prompt": "测试正确的去水印格式"
  }
}
```

## 🎉 预期效果

### ✅ 去水印功能
- `label_watermark: 0` 在正确位置 (`base_parameter_extra`) 应该完全移除水印
- 不再需要多重参数设置，单一正确参数即可

### ✅ 比例控制
- `generation_ratio_width: 540, generation_ratio_height: 960` 应该产生完美的9:16纵向视频
- 比例控制将更加精确和可靠

## 💡 技术要点

### 关键修改
1. **参数结构重组**: 使用 `base_parameter_extra` 包装核心参数
2. **参数名称修正**: 使用GLM API期望的确切参数名
3. **去除冗余**: 移除之前的多重参数设置

### 兼容性保证
- 保持原有的路由接口不变
- 内部参数映射到正确的GLM API格式
- 向后兼容现有的调用方式

---

**结论**: 通过用户提供的实际参数格式，我们现在能够正确实现去水印和精确比例控制功能。这次修复应该完全解决用户反馈的问题。