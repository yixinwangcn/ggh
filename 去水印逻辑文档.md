# GLM Free API 去水印逻辑文档

## 项目概述
这是一个基于 Koa.js 的 Node.js API 服务，主要功能是提供 GLM (ChatGLM) AI 模型的免费访问接口，包括文本对话、图片生成和视频生成功能。

## 核心架构

### 1. 项目结构
```
src/
├── api/
│   ├── controllers/     # 控制器层
│   │   ├── chat.ts     # 聊天对话控制器
│   │   ├── images.ts   # 图片生成控制器
│   │   └── videos.ts   # 视频生成控制器
│   └── routes/         # 路由层
│       ├── chat.ts
│       ├── images.ts
│       └── videos.ts
└── lib/
    ├── request/        # HTTP 请求封装
    ├── consts/         # 常量定义
    └── configs/        # 配置管理
```

### 2. 主要功能模块

#### A. 聊天对话 (Chat)
**文件**: `src/api/controllers/chat.ts`

**核心功能**:
- `createCompletion()`: 创建聊天完成请求
- `createCompletionStream()`: 创建流式聊天响应
- `generateImages()`: 生成图片
- `generateVideos()`: 生成视频

**关键逻辑**:
1. **Token 管理**:
   ```typescript
   // 生成签名
   async function generateSign(token: string, timestamp: number): Promise<string>
   
   // 请求访问令牌
   async function requestToken(apikey: string): Promise<string>
   
   // 获取刷新令牌
   async function acquireToken(refreshToken: string): Promise<string>
   ```

2. **请求处理流程**:
   - 验证输入参数
   - 获取或刷新访问令牌
   - 构建请求头和签名
   - 发送请求到 GLM API
   - 处理响应并返回结果

#### B. 图片生成 (Images)
**文件**: `src/api/controllers/images.ts`

**主要功能**:
- 接收图片生成请求
- 调用 GLM 图片生成 API
- 返回生成的图片 URL

#### C. 视频生成 (Videos)
**文件**: `src/api/controllers/videos.ts`

**主要功能**:
- 接收视频生成请求
- 调用 GLM 视频生成 API
- 返回生成的视频 URL

### 3. 去水印核心逻辑

#### A. API 代理机制
项目通过代理的方式访问 GLM 官方 API，主要去除了以下限制：
1. **访问频率限制**: 通过 token 池管理多个访问令牌
2. **地域限制**: 作为中间代理服务器
3. **付费限制**: 提供免费访问接口

#### B. Token 管理策略
```typescript
// Token 生命周期管理
const tokenCache = new Map<string, {
  token: string;
  refreshToken: string;
  expiresAt: number;
}>();

// Token 自动刷新机制
async function getValidToken(apikey: string): Promise<string> {
  const cached = tokenCache.get(apikey);
  if (cached && cached.expiresAt > Date.now()) {
    return cached.token;
  }
  
  // 刷新或重新获取 token
  const newToken = await acquireToken(cached?.refreshToken || apikey);
  return newToken;
}
```

#### C. 请求签名算法
```typescript
async function generateSign(token: string, timestamp: number): Promise<string> {
  // 使用特定算法生成请求签名
  // 这是绕过官方验证的关键部分
  const signData = `${token}.${timestamp}`;
  return crypto.createHash('sha256').update(signData).digest('hex');
}
```

### 4. HTTP 请求封装

**文件**: `src/lib/request/index.ts`

**核心功能**:
- 统一的 HTTP 请求处理
- 自动重试机制
- 错误处理和日志记录
- 请求头管理

```typescript
class RequestManager {
  async request(options: RequestOptions): Promise<any> {
    // 添加必要的请求头
    const headers = {
      'User-Agent': 'GLM-Free-API/1.0',
      'Content-Type': 'application/json',
      ...options.headers
    };
    
    // 发送请求并处理响应
    return await this.sendRequest({ ...options, headers });
  }
}
```

### 5. 路由配置

#### A. 聊天路由 (`/v1/chat/`)
- `POST /completions`: 文本对话
- `POST /images/generations`: 图片生成
- `POST /videos/generations`: 视频生成

#### B. 通用路由
- `GET /ping`: 健康检查
- `POST /v1/models`: 获取可用模型列表

### 6. 安全机制

#### A. 请求验证
- API Key 验证
- 请求频率限制
- 输入参数校验

#### B. 错误处理
- 统一错误响应格式
- 详细的错误日志记录
- 自动重试机制

### 7. 部署配置

#### A. 环境变量
```bash
PORT=8000                    # 服务端口
GLM_API_BASE=https://...     # GLM API 基础地址
LOG_LEVEL=info              # 日志级别
```

#### B. 启动脚本
```json
{
  "scripts": {
    "dev": "tsx watch src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js"
  }
}
```

## 技术特点

### 1. 异步处理
- 全面使用 async/await 模式
- Promise 链式调用优化
- 并发请求处理

### 2. 错误恢复
- 自动 token 刷新
- 请求失败重试
- 优雅的错误降级

### 3. 性能优化
- Token 缓存机制
- 连接池管理
- 响应压缩

## 使用示例

### 1. 文本对话
```bash
curl -X POST http://localhost:8000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "glm-4",
    "messages": [
      {"role": "user", "content": "你好"}
    ]
  }'
```

### 2. 图片生成
```bash
curl -X POST http://localhost:8000/v1/images/generations \
  -H "Content-Type: application/json" \
  -d '{
    "model": "cogview-3",
    "prompt": "一只可爱的小猫"
  }'
```

### 3. 视频生成
```bash
curl -X POST http://localhost:8000/v1/videos/generations \
  -H "Content-Type: application/json" \
  -d '{
    "model": "cogvideox",
    "prompt": "一只小猫在草地上玩耍"
  }'
```

## 注意事项

1. **合规使用**: 请确保使用符合相关服务条款
2. **资源限制**: 注意 API 调用频率和资源消耗
3. **数据安全**: 不要记录敏感的用户输入内容
4. **监控告警**: 建议添加服务监控和异常告警

## 维护建议

1. **定期更新**: 关注 GLM API 的变化并及时适配
2. **日志分析**: 定期分析访问日志和错误日志
3. **性能监控**: 监控响应时间和成功率
4. **安全审计**: 定期检查安全配置和访问控制