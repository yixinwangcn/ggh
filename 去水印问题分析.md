# 🚫 GLM 去水印问题深度分析

## 🔍 问题现状

### 用户反馈
- **去水印**: ❌ 完全没有效果，生成的视频仍有水印
- **比例控制**: ❌ 设置9:16，实际得到其他比例
- **整体效果**: 两个核心功能都没有实现

### 当前实现分析
```typescript
// 当前代码中的实现
const requestBody = {
  conversation_id: refConvId,
  prompt,
  source_list: sourceList,
  label_watermark: options.labelWatermark ?? 0, // 这个参数可能无效
  advanced_parameter_extra: {
    emotional_atmosphere: options.emotionalAtmosphere,
    mirror_mode: options.mirrorMode,
    video_style: options.videoStyle,
  },
  // 其他参数...
};
```

## 🧪 可能的问题原因

### 1. 参数名称错误
GLM API可能使用不同的参数名：
- `watermark: false` 而不是 `label_watermark: 0`
- `no_watermark: true`
- `remove_watermark: true`
- `watermark_enabled: false`

### 2. 参数位置错误
去水印参数可能需要放在：
- `advanced_parameter_extra` 对象中
- `options` 对象中
- 请求的根级别

### 3. 参数值格式错误
可能需要：
- 布尔值而不是数字：`false` 而不是 `0`
- 字符串值：`"none"` 而不是 `0`
- 特殊的标识符

### 4. API端点错误
可能需要使用不同的API端点或版本

## 🔧 解决方案尝试

### 方案1: 测试不同参数名称
```javascript
const watermarkTests = [
  { label_watermark: 0 },
  { watermark: false },
  { no_watermark: true },
  { remove_watermark: true },
  { watermark_enabled: false }
];
```

### 方案2: 测试不同参数位置
```javascript
// 在根级别
{ label_watermark: 0 }

// 在advanced_parameter_extra中
{ 
  advanced_parameter_extra: {
    label_watermark: 0
  }
}

// 在options中
{
  options: {
    label_watermark: 0
  }
}
```

### 方案3: 研究GLM官方API
需要：
1. 查看GLM官方文档
2. 分析官方网站的网络请求
3. 对比官方参数格式

## 🎯 立即行动计划

### 1. 参数格式测试
- 测试所有可能的参数名称组合
- 测试不同的参数位置
- 测试不同的参数值格式

### 2. 网络请求分析
- 抓取GLM官网的实际请求
- 对比我们的请求格式
- 找出差异点

### 3. 代码修复
- 根据测试结果修复参数传递
- 确保参数正确到达GLM API
- 添加详细的调试日志

## 🔍 调试策略

### 1. 请求日志分析
```typescript
console.log('🎬 发送到GLM API的完整请求:', JSON.stringify(requestBody, null, 2));
```

### 2. 响应对比
- 对比有水印和无水印请求的响应
- 查看是否有错误信息或警告

### 3. 参数验证
- 确认每个参数都正确传递
- 验证参数类型和格式

## 💡 可能的正确格式

基于常见的API设计模式，正确的格式可能是：

### 格式A: 布尔值控制
```json
{
  "model": "cogvideox",
  "prompt": "做个动画",
  "watermark": false,
  "image_url": "...",
  "options": {...}
}
```

### 格式B: 字符串控制
```json
{
  "model": "cogvideox",
  "prompt": "做个动画",
  "watermark_mode": "none",
  "image_url": "...",
  "options": {...}
}
```

### 格式C: 嵌套控制
```json
{
  "model": "cogvideox",
  "prompt": "做个动画",
  "image_url": "...",
  "options": {
    "watermark": false,
    "label_watermark": 0
  }
}
```

## 🎯 下一步行动

1. **立即测试**: 运行参数格式测试脚本
2. **分析日志**: 查看服务器日志中的实际请求
3. **对比官方**: 研究GLM官网的请求格式
4. **修复代码**: 根据发现的正确格式修复实现
5. **验证效果**: 确认去水印功能正常工作

---

**目标**: 在接下来的测试中找到正确的去水印参数格式，确保生成的视频完全无水印。