# 🎬 GLM 视频去水印功能实现

## 🎯 核心去水印参数

### `label_watermark` 参数
- **0**: 无水印 (推荐设置)
- **1**: 有水印 (默认官方设置)

## 🚀 使用方法

### 1. 基础去水印请求 (纵向9:16)
```bash
curl -X POST "http://localhost:8000/v1/videos/generations" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "model": "cogvideox",
    "prompt": "做个纵向动画",
    "label_watermark": 0,
    "image_url": "https://example.com/image.jpg",
    "options": {
      "generationPattern": 1,
      "resolution": 2,
      "fps": 60,
      "duration": 1,
      "ratioWidth": 608,
      "ratioHeight": 1080
    }
  }'
```

### 1.2 横向视频请求 (16:9)
```bash
curl -X POST "http://localhost:8000/v1/videos/generations" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "model": "cogvideox",
    "prompt": "做个横向动画",
    "label_watermark": 0,
    "image_url": "https://example.com/image.jpg",
    "options": {
      "generationPattern": 1,
      "resolution": 2,
      "fps": 60,
      "duration": 1,
      "ratioWidth": 1080,
      "ratioHeight": 608
    }
  }'
```

### 2. JavaScript 调用示例
```javascript
const response = await axios.post('http://localhost:8000/v1/videos/generations', {
  model: "cogvideox",
  prompt: "做个动画",
  label_watermark: 0, // 关键去水印参数
  image_url: "https://example.com/image.jpg",
  options: {
    generationPattern: 1,
    resolution: 2,
    fps: 60,
    duration: 1,
    ratioWidth: 608,
    ratioHeight: 1080
  }
}, {
  headers: {
    'Authorization': 'Bearer YOUR_TOKEN',
    'Content-Type': 'application/json'
  }
});
```

## 🔧 支持的参数

### 必需参数
- `model`: 模型名称 (如: "cogvideox")
- `prompt`: 视频描述文本

### 去水印参数
- `label_watermark`: 水印控制 (0=无水印, 1=有水印)

### 可选参数
- `image_url`: 参考图片URL
- `video_style`: 视频风格 ("卡通3D", "黑白老照片", "油画", "电影感")
- `emotional_atmosphere`: 情感氛围 ("温馨和谐", "生动活泼", "紧张刺激", "凄凉寂寞")
- `mirror_mode`: 镜像模式 ("水平", "垂直", "推近", "拉远")
- `audio_id`: 音频ID

### 高级选项 (options)
```json
{
  "generationPattern": 1,    // 生成模式
  "resolution": 2,           // 分辨率
  "fps": 60,                // 帧率
  "duration": 1,            // 时长
  "ratioWidth": 608,        // 宽度比例 (纵向9:16)
  "ratioHeight": 1080       // 高度比例 (纵向9:16)
}
```

### 📐 常用比例设置
- **9:16 纵向** (手机竖屏): `ratioWidth: 608, ratioHeight: 1080`
- **16:9 横向** (电脑横屏): `ratioWidth: 1080, ratioHeight: 608`
- **1:1 正方形**: `ratioWidth: 720, ratioHeight: 720`
- **4:3 传统**: `ratioWidth: 720, ratioHeight: 960`

## 🎨 实现原理

### 1. 请求拦截与修改
```typescript
// 在发送到GLM API之前，自动添加去水印参数
const result = await axios.post(
  `https://chatglm.cn/chatglm/video-api/v1/chat`,
  {
    conversation_id: refConvId,
    prompt,
    source_list: sourceList.length > 0 ? sourceList : undefined,
    label_watermark: 0, // 🔑 关键去水印参数
    advanced_parameter_extra: {
      emotional_atmosphere: options.emotionalAtmosphere,
      mirror_mode: options.mirrorMode,
      video_style: options.videoStyle,
    },
    options: {
      generationPattern: 1,
      resolution: 2,
      fps: 60,
      duration: 1,
      ratioWidth: 608,
      ratioHeight: 1080
    }
  }
);
```

### 2. 默认去水印设置
- 所有视频生成请求默认设置 `label_watermark: 0`
- 用户可以通过参数覆盖此设置
- 确保生成的视频没有官方水印

## 🧪 测试验证

### 运行测试脚本
```bash
node test_watermark_removal.js
```

### 对比测试
1. **带水印**: `label_watermark: 1`
2. **无水印**: `label_watermark: 0`

## ✅ 功能验证清单

- [ ] 视频生成成功
- [ ] 返回视频URL
- [ ] 视频无水印
- [ ] 支持自定义参数
- [ ] 错误处理正常

## 🔍 故障排除

### 常见问题

1. **仍然有水印**
   - 检查 `label_watermark` 是否设置为 0
   - 确认请求参数格式正确

2. **生成失败**
   - 检查 Authorization token 是否有效
   - 确认网络连接正常
   - 查看服务器日志

3. **参数错误**
   - 验证所有必需参数都已提供
   - 检查参数类型和格式

## 📝 注意事项

1. **Token 有效性**: 确保使用有效的 GLM refresh token
2. **请求频率**: 避免过于频繁的请求
3. **资源消耗**: 视频生成需要较长时间，请耐心等待
4. **合规使用**: 请遵守相关服务条款和使用规范

## 🎉 成功示例

成功的去水印视频生成响应：
```json
{
  "created": 1704067200,
  "data": [
    {
      "conversation_id": "65a1b2c3d4e5f6789012345",
      "cover_url": "https://example.com/cover.jpg",
      "video_url": "https://example.com/video.mp4",
      "video_duration": 5.0,
      "resolution": "1080x1920"
    }
  ]
}
```

生成的视频将不包含任何官方水印！🎊